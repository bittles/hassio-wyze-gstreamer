#!/usr/bin/with-contenv bashio
set -eu

bashio::log.info "Starting Cam1 Hi Res Stream"
# Create main config


RTSP_SIMPLE_SERVER_IP=$(bashio::config 'rtsp-simple-server-ip')
RTSP_SIMPLE_SERVER_PORT=$(bashio::config 'rtsp-simple-server-port')
CAM1_IP=$(bashio::config 'cam1-ip')
CAM1_RTSP_PORT=$(bashio::config 'cam1-rtsp-port')
CAM1_USERNAME=$(bashio::config 'cam1-username')
CAM1_PASSWORD=$(bashio::config 'cam1-password')
CAM1_RTSP_SS_HI_RES_PATH=$(bashio::config 'cam1-rtsp-ss-hi-res-path')
CAM1_RTSP_SS_LO_RES_PATH=$(bashio::config 'cam1-rtsp-ss-lo-res-path')

rm -f gstream-cam1-hi.log

tail --pid $$ -F gstream-cam1-hi.log &

gst-launch-1.0 rtspsrc protocols=tcp \
location='rtsp://driveway:kPaWrZG8A9@192.168.21.61:8654/video1_unicast' \
latency=120 buffer-mode=3 connection-speed=2000 add-reference-timestamp-meta=true \
name=t t. ! queue ! \
capsfilter caps="application/x-rtp,media=video,height=1920,width=1080,framerate=20/1" ! \
queue ! rtph264depay ! h264parse ! h264timestamper ! queue ! \
rtspclientsink protocols=tcp latency=0 \
location=rtsp://192.168.21.40:8554/driveway_hi \
name=pay t. ! queue ! \
capsfilter caps="application/x-rtp,media=audio,clock-rate=16000,encoding-name=L16" ! \
rtpL16depay ! queue ! audioconvert ! queue ! \
volume volume=1.5 ! audioresample ! \
opusenc audio-type=2051 bandwidth=-1000 \
bitrate=64000 frame-size=40 ! queue ! \
pay. -e > gstream-cam1-hi.log
